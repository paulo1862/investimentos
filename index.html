<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Gerenciador de Investimentos 2025</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
        .header { background: #004085; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .actions { display: flex; gap: 10px; }
        .btn { padding: 12px 20px; text-decoration: none; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; color: white; transition: 0.3s; }
        .btn-add { background: #28a745; }
        .btn-refresh { background: #ffc107; color: #212529; }
        .btn:hover { opacity: 0.8; }
        .container { width: 95%; margin: 30px auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-x: auto; margin-bottom: 30px; }
        h2 { margin-top: 0; color: #004085; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 1.5rem; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #495057; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }
        .pos-lucro { color: #28a745; font-weight: bold; }
        .pos-prejuizo { color: #dc3545; font-weight: bold; }
        .ticker { font-weight: bold; color: #004085; }
        .btn-delete { color: #bdc3c7; cursor: pointer; border: none; background: none; font-size: 1.2rem; transition: 0.2s; }
        .btn-delete:hover { color: #dc3545; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Investimentos 2025</h1>
        <div class="actions">
            <button class="btn btn-refresh" onclick="atualizarMeusAtivos()">üîÑ Atualizar Meus Ativos</button>
            <a href="adicionar_ativo.html" class="btn btn-add">+ Novo Ativo</a>
        </div>
    </div>

    <div class="container">
        <!-- SE√á√ÉO TOP 10 B3 -->
        <div class="card">
            <h2>Top 10 A√ß√µes da B3 (Tempo Real)</h2>
            <table>
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th>Nome da Empresa</th>
                        <th>Pre√ßo Atual (R$)</th>
                        <th>Varia√ß√£o (%)</th>
                    </tr>
                </thead>
                <tbody id="top10-corpo">
                    <tr><td colspan="4">Conectando √† bolsa de valores...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- SE√á√ÉO MINHA CARTEIRA -->
        <div class="card">
            <h2>Meus Investimentos Pessoais</h2>
            <table>
                <thead>
                    <tr>
                        <th>Ativo</th>
                        <th>Tipo</th>
                        <th>Qtd</th>
                        <th>P. M√©dio (R$)</th>
                        <th>Pre√ßo Mercado (R$)</th>
                        <th>Patrim√¥nio Atual</th>
                        <th>Lucro/Preju√≠zo</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabela-corpo">
                    <tr><td colspan="8">Nenhum ativo cadastrado. Clique em "+ Novo Ativo".</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Configura√ß√µes de Formata√ß√£o
        const fmtMoeda = (v) => v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const fmtDec = (v) => Number(parseFloat(v).toFixed(10)).toString().replace('.', ',');
        
        // --- SEU TOKEN PESSOAL ---
        const MEU_TOKEN = "en4hSkmZoFaEh9oQeFsqqM";
        const TOP_10_LIST = "VALE3,PETR4,ITUB4,ABEV3,BBDC4,BBAS3,WEGE3,ITSA4,RENT3,SANB11";

        // Fun√ß√£o para carregar cota√ß√µes do mercado (Top 10)
        async function carregarTop10() {
            try {
                const res = await fetch(`brapi.dev{TOP_10_LIST}?token=${MEU_TOKEN}`);
                const data = await res.json();
                const corpo = document.getElementById('top10-corpo');
                corpo.innerHTML = '';

                data.results.forEach(acao => {
                    const variacao = acao.regularMarketChangePercent ? acao.regularMarketChangePercent.toFixed(2) : "0.00";
                    const corClasse = variacao >= 0 ? 'pos-lucro' : 'pos-prejuizo';
                    
                    corpo.innerHTML += `
                        <tr>
                            <td class="ticker">${acao.symbol}</td>
                            <td>${acao.longName || 'Empresa B3'}</td>
                            <td>R$ ${fmtMoeda(acao.regularMarketPrice)}</td>
                            <td class="${corClasse}">${variacao}%</td>
                        </tr>`;
                });
            } catch (e) {
                document.getElementById('top10-corpo').innerHTML = '<tr><td colspan="4">Erro ao buscar dados do Top 10. Verifique sua conex√£o.</td></tr>';
            }
        }

        // Fun√ß√£o para atualizar pre√ßos da sua carteira pessoal
        async function atualizarMeusAtivos() {
            let ativos = JSON.parse(localStorage.getItem('invest_2025')) || [];
            // Filtra apenas o que √© Bolsa (A√ß√µes/FIIs)
            const ativosBolsa = ativos.filter(x => x.tipo === 'A√ß√£o' || x.tipo === 'FII');
            const tickers = ativosBolsa.map(x => x.nome).join(',');
            
            if (!tickers) return alert("Cadastre A√ß√µes ou FIIs para atualizar via mercado.");

            try {
                const res = await fetch(`brapi.dev{tickers}?token=${MEU_TOKEN}`);
                const data = await res.json();

                if (!data.results) throw new Error("Erro na API");

                ativos.forEach(a => {
                    const info = data.results.find(r => r.symbol === a.nome);
                    if (info) a.precoMercado = info.regularMarketPrice;
                });

                localStorage.setItem('invest_2025', JSON.stringify(ativos));
                renderizarCarteira();
                alert("Cota√ß√µes atualizadas com seu token!");
            } catch (e) {
                alert("Erro ao atualizar. Verifique se os Tickers est√£o corretos ou se o Token expirou.");
            }
        }

        // Fun√ß√£o para desenhar sua carteira na tela
        function renderizarCarteira() {
            const corpo = document.getElementById('tabela-corpo');
            const ativos = JSON.parse(localStorage.getItem('invest_2025')) || [];
            if (ativos.length === 0) return;

            corpo.innerHTML = "";
            ativos.forEach((item, index) => {
                const qtd = parseFloat(item.quantidade);
                const pMedio = parseFloat(item.preco);
                const pMercado = item.precoMercado || pMedio;
                const valorAtual = qtd * pMercado;
                const lucroTotal = (pMercado - pMedio) * qtd;

                corpo.innerHTML += `
                    <tr>
                        <td class="ticker">${item.nome}</td>
                        <td>${item.tipo}</td>
                        <td>${fmtDec(qtd)}</td>
                        <td>R$ ${fmtMoeda(pMedio)}</td>
                        <td>R$ ${fmtMoeda(pMercado)}</td>
                        <td>R$ ${fmtMoeda(valorAtual)}</td>
                        <td class="${lucroTotal >= 0 ? 'pos-lucro' : 'pos-prejuizo'}">R$ ${fmtMoeda(lucroTotal)}</td>
                        <td><button class="btn-delete" title="Excluir" onclick="remover(${index})">üóëÔ∏è</button></td>
                    </tr>`;
            });
        }

        function remover(index) {
            if (confirm("Tem certeza que deseja excluir este ativo?")) {
                let ativos = JSON.parse(localStorage.getItem('invest_2025'));
                ativos.splice(index, 1);
                localStorage.setItem('invest_2025', JSON.stringify(ativos));
                renderizarCarteira();
            }
        }

        // Inicializa√ß√£o ao carregar a p√°gina
        window.onload = () => {
            carregarTop10();
            renderizarCarteira();
        };
    </script>
</body>
</html>
